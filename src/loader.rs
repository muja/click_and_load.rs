use crate::js::{Context, Result as JsResult};
use aes::cipher::{
    block_padding::{ZeroPadding, UnpadError},
    BlockDecryptMut, KeyIvInit,
};
use axum::{extract::State, response::IntoResponse, Form};
use futures::{channel::mpsc::Sender, SinkExt, TryFutureExt};
use hyper::StatusCode;
use serde::Deserialize;
use std::{
    str::{self, Utf8Error},
    sync::Arc,
};
use tokio::{io::AsyncWriteExt, sync::Mutex};

#[derive(Debug, Deserialize)]
pub struct Content {
    jk: String,
    crypted: String,
}

#[instrument(ret)]
pub fn key_from_snippet(jk: &str) -> JsResult<String> {
    Context::new().click_and_load(jk)
}

type Aes128Cbc = cbc::Decryptor<aes::Aes128>;
pub fn decrypt<'a>(key: &[u8], crypted: &'a mut [u8]) -> Result<&'a [u8], UnpadError> {
    let key = &key[0..16]; // trim to 128 bytes
    Aes128Cbc::new(key.into(), key.into()).decrypt_padded_mut::<ZeroPadding>(crypted)
}

#[derive(Debug)]
enum Error {
    DecodeBase64(base64::DecodeError),
    KeyInvalid(hex::FromHexError),
    InternalError,
    Decrypt(UnpadError),
    Utf8(Utf8Error),
}

impl IntoResponse for Error {
    fn into_response(self) -> axum::response::Response {
        use Error::*;
        match self {
            DecodeBase64(error) => (
                StatusCode::BAD_REQUEST,
                format!("invalid base64: {}", error),
            ),
            KeyInvalid(error) => (StatusCode::BAD_REQUEST, format!("invalid key: {}", error)),
            Decrypt(_) => (
                StatusCode::BAD_REQUEST,
                format!("Decryption failed, check `crypted` parameter"),
            ),
            Utf8(error) => (StatusCode::BAD_REQUEST, format!("utf8 error: {}", error)),
            _ => (
                StatusCode::INTERNAL_SERVER_ERROR,
                format!("internal server error"),
            ),
        }
        .into_response()
    }
}

#[instrument(ret)]
pub async fn handle(
    state: State<Arc<Mutex<Sender<Vec<String>>>>>,
    Form(body): Form<Content>,
) -> Result<&'static str, impl IntoResponse> {
    #[allow(deprecated)]
    if let Some(home_dir) = std::env::home_dir() {
        let path = home_dir.join("Library/Logs/unget/jks");
        let result = tokio::fs::OpenOptions::new()
            .create(true)
            .append(true)
            .open(&path)
            .and_then(|file| async {
                futures::pin_mut!(file);
                file.write_all(body.jk.as_bytes()).await?;
                file.write_u8('\n' as u8).await?;
                Ok(())
            })
            .await;
        if let Err(e) = result {
            tracing::error!("failed to write to {path:?}: {e:?}");
        }
    }
    let mut bytes =
        base64::Engine::decode(&base64::engine::general_purpose::STANDARD, &body.crypted)
            .map_err(Error::DecodeBase64)?;
    let bytes = key_from_snippet(&body.jk)
        .or(Err(Error::InternalError))
        .and_then(|val| hex::decode(val).map_err(Error::KeyInvalid))
        .and_then(|key| decrypt(&key, &mut bytes).map_err(Error::Decrypt))?;
    trace!("bytes: {:?}", bytes);
    let links = bytes
        .split(|&b| b == b'\n' || b == b'\r')
        .filter(|&xs| xs.len() > 0)
        .map(|slice| str::from_utf8(slice).map(|s| s.into()))
        .collect::<Result<Vec<String>, _>>()
        .map_err(Error::Utf8)?;
    if let Err(e) = state.lock().await.send(links).await {
        warn!("Error sending to receiver {:?}", e);
        Err(Error::InternalError)
    } else {
        Ok("success\r\n")
    }
}

#[cfg(test)]
mod tests {
    #[test]
    fn decrypt() {
        let subscriber = tracing_subscriber::FmtSubscriber::builder()
            .with_env_filter(
                "trace,hyper=info"
                    .parse::<tracing_subscriber::EnvFilter>()
                    .unwrap(),
            )
            .with_writer(std::io::stderr)
            .finish();
        tracing::subscriber::set_global_default(subscriber)
            .expect("setting default subscriber failed");
        let key: Vec<u8> = vec![
            53, 56, 54, 56, 51, 51, 57, 53, 50, 55, 51, 57, 56, 51, 52, 56,
        ];
        let mut crypted: Vec<u8> = vec![
            58, 11, 41, 213, 16, 177, 2, 66, 75, 72, 18, 81, 121, 242, 226, 134, 179, 108, 98, 36,
            83, 221, 110, 125, 93, 0, 244, 115, 205, 104, 109, 120, 174, 186, 147, 18, 45, 28, 29,
            174, 184, 97, 226, 215, 76, 171, 80, 75, 9, 54, 129, 59, 215, 229, 39, 143, 215, 16,
            130, 51, 134, 48, 142, 178, 94, 80, 165, 93, 175, 224, 10, 23, 17, 137, 37, 240, 246,
            108, 46, 171, 51, 107, 198, 60, 211, 167, 37, 238, 201, 233, 235, 97, 102, 255, 201,
            146, 190, 148, 135, 48, 51, 139, 180, 112, 85, 107, 18, 160, 210, 219, 138, 91, 14, 61,
            81, 243, 230, 203, 37, 170, 69, 254, 234, 124, 234, 30, 13, 5, 236, 136, 90, 217, 211,
            204, 30, 238, 215, 210, 75, 5, 238, 35, 148, 21, 120, 140, 99, 104, 2, 238, 238, 177,
            231, 126, 140, 107, 13, 249, 244, 133, 191, 90, 126, 44, 68, 171, 4, 97, 112, 226, 224,
            190, 69, 234, 204, 96, 95, 215, 180, 189, 6, 12, 239, 230, 75, 255, 190, 149, 172, 170,
            172, 68, 230, 210, 183, 54, 208, 158, 160, 221, 10, 147, 2, 112, 148, 177, 217, 250,
            82, 102, 234, 133, 5, 58, 133, 98, 188, 185, 145, 67, 222, 64, 237, 38, 139, 149, 236,
            119, 30, 124, 166, 162, 208, 16, 171, 242, 196, 156, 77, 198, 107, 237, 250, 104, 234,
            71, 196, 123, 34, 109, 124, 204, 18, 120, 95, 205, 32, 117, 126, 96, 169, 17, 32, 230,
            130, 94, 141, 128, 9, 185, 125, 87, 143, 107, 65, 63, 216, 34, 246, 180, 174, 122, 143,
            205, 177, 207, 172, 8, 60, 24, 204, 97, 119, 79, 100, 249, 120, 34, 124, 27, 32, 113,
            113, 228, 135, 210, 150, 87, 52, 202, 185, 136, 165, 140, 159, 48, 188, 115, 155, 160,
            68, 225, 15, 212, 45, 34, 112, 105, 114, 17, 167, 121, 244, 100, 28, 101, 121, 97, 92,
            58, 246, 179, 207, 164, 241, 165, 226, 24, 151, 240, 160, 126, 4, 248, 32, 248, 220,
            12, 139, 254, 109, 34, 21, 248, 139, 49, 75, 248, 154, 116, 89, 216, 130, 31, 181, 120,
            76, 81, 14, 106, 7, 170, 44, 52, 13, 88, 109, 98, 30, 93, 123, 62, 229, 85, 143, 220,
            193, 254, 221, 85, 220, 69, 206, 116, 43, 149, 9, 63, 105, 169, 165, 222, 207, 185, 9,
            96, 90, 237, 137, 234, 166, 28, 14, 70, 44, 181, 102, 44, 142, 90, 142, 149, 152, 26,
            82, 160, 10, 93, 188, 34, 28, 33, 213, 39, 66, 96, 213, 154, 28, 134, 111, 68, 48, 102,
            1, 191, 71, 24, 141, 146, 140, 237, 43, 82, 133, 149, 156, 119, 208, 28, 244, 148, 5,
            89, 91, 130, 65, 162, 35, 102, 236, 93, 32, 106, 22, 79, 201, 97, 206, 115, 154, 72,
            244, 84, 159, 230, 218, 254, 92, 187, 140, 10, 10, 202, 77, 8, 221, 133, 248, 225, 56,
            124, 97, 28, 86, 126, 240, 157, 115, 183, 172, 69, 142, 55, 105, 48, 244, 179, 160,
            130, 224, 237, 121, 39, 53, 128, 82, 38, 93, 21, 189, 8, 39, 105, 120, 234, 79, 186,
            235, 6, 197, 64, 155, 88, 40, 76, 228, 117, 48, 173, 70, 41, 24, 8, 33, 207, 41, 153,
            133, 73, 22, 170, 96, 160, 66, 87, 245, 182, 6, 177, 92, 89, 152, 208, 146, 246, 110,
            10, 3, 78, 30, 6, 155, 151, 186, 189, 112, 75, 154, 213, 237, 186, 183, 216, 137, 53,
            85, 50, 167, 219, 74, 158, 39, 100, 219, 145, 15, 1, 120, 222, 110, 102, 219, 192, 85,
            134, 75, 144, 7, 10, 105, 13, 62, 136, 177, 71, 173, 103, 49, 124, 84, 192, 81, 60, 0,
            153, 184, 239, 87, 116, 10, 184, 145, 123, 177, 254, 243, 112, 155, 59, 56, 101, 107,
            199, 39, 43, 226, 153, 155, 124, 74, 82, 137, 171, 178, 188, 96, 170, 90, 232, 140,
            158, 178, 238, 217, 64, 95, 246, 105, 88, 184, 173, 7, 5, 57, 113, 71, 112, 147, 51,
            189, 70, 114, 239, 13, 61, 163, 128, 53, 21, 16, 198, 247, 17, 80, 239, 180, 120, 44,
            88, 161, 84, 118, 124, 93, 146, 50, 59, 25, 144, 234, 39, 237, 52, 78, 88, 150, 205,
            130, 113, 230, 158, 55, 76, 177, 57, 118, 66, 90, 108, 167, 193, 99, 160, 86, 232, 94,
            139, 78, 248, 29, 212, 38, 61, 67, 64, 174, 138, 115, 210, 63, 102, 166, 237, 149, 1,
            214, 146, 28, 169, 106, 165, 131, 226, 67, 18, 102, 65, 102, 123, 188, 15, 197, 28,
            242, 227, 30, 121, 232, 48, 105, 12, 139, 50, 57, 19, 201, 77, 91, 110, 96, 216, 206,
            36, 214, 54, 181, 248, 153, 72, 61, 30, 48, 121, 85, 45, 31, 21, 224, 61, 210, 187, 86,
            246, 161, 55, 21, 61, 77, 186, 96, 84, 130, 95, 2, 14, 230, 52, 79, 44, 214, 102, 188,
            208, 243, 84, 86, 109, 43, 248, 111, 251, 210, 186, 192, 146, 58, 35, 89, 127, 76, 168,
            43, 133, 240, 66, 107, 236, 33, 246, 115, 246, 148, 50, 228, 45, 20, 248, 91, 0, 71,
            95, 206, 221, 195, 54, 96, 213, 186, 2, 180, 41, 108, 65, 212, 162, 45, 173, 187, 170,
            26, 151, 57, 153, 37, 209, 7, 22, 103, 81, 5, 16, 37, 110, 196, 146, 87, 17, 85, 90,
            80, 204, 56, 158, 238, 48, 171, 29, 67, 100, 153, 134, 2, 105, 117, 238, 176, 165, 138,
            164, 72, 249, 13, 121, 97, 84, 86, 38, 12, 169, 5, 31, 18, 104, 180, 212, 37, 212, 71,
            241, 214, 16, 133, 238, 200, 34, 191, 216, 40, 35, 10, 253, 187, 111, 219, 81, 119, 35,
            159, 204, 225, 224, 108, 187, 25, 116, 117, 202, 229, 191, 193, 236, 152, 184, 201, 89,
            172, 222, 253, 247, 146, 203, 101, 147, 196, 92, 197, 217, 115, 200, 255, 240, 9, 4,
            143, 160, 78, 85, 248, 118, 180, 118, 148, 57, 83, 109, 96, 241, 127, 244, 57, 113,
            243, 128, 225, 244, 167, 213, 146, 250, 76, 233, 89, 82, 18, 242, 231, 69, 239, 4, 189,
            90, 168, 13, 3, 242, 48, 50, 108, 174, 183, 37, 2, 78, 41, 162, 49, 183, 236, 191, 156,
            59, 243, 84, 220, 209, 240, 225, 107, 83, 151, 142, 146, 139, 181, 30, 186, 28, 162,
            209, 39, 148, 213, 175, 90, 245, 14, 250, 253, 125, 141, 250, 230, 77, 112, 201, 206,
            175, 85, 73, 210, 180, 120, 214, 86, 124, 101, 87, 166, 239, 84, 100, 146, 187, 6, 13,
            43, 255, 136, 255, 118, 236, 84, 191, 204, 150, 0, 240, 164, 176, 140, 122, 253, 189,
            225, 69, 30, 32, 195, 242, 27, 213, 74, 26, 235, 250, 72, 90, 128, 65, 152, 222, 197,
            195, 16, 105, 170, 93, 191, 234, 126, 79, 16, 23, 216, 10, 153, 47, 15, 120, 49, 60,
            169, 105, 255, 91, 208, 23, 197, 56, 205, 78, 150, 109, 189, 127, 255, 41, 178, 20, 2,
            253, 215, 23, 101, 213, 176, 216, 212, 45, 178, 143, 252, 219, 50, 85, 96, 87, 170, 75,
            47, 119, 95, 202, 107, 130, 159, 131, 237, 59, 58, 178, 126, 93, 12, 62, 185, 167, 125,
            81, 245, 28, 192, 83, 8, 142, 224, 73, 130, 56, 129, 70, 239, 24, 30, 124, 173, 148,
            75, 96, 25, 49, 75, 51, 144, 224, 23, 75, 122, 65, 126, 35, 202, 221, 67, 17, 39, 189,
            128, 219, 162, 238, 249, 228, 16, 1, 157, 102, 0, 150, 21, 99, 53, 204, 25, 38, 4, 95,
            19, 44, 40, 113, 83, 116, 178, 44, 52, 80, 211, 70, 210, 73, 86, 40, 251, 107, 143,
            224, 34, 176, 205, 85, 188, 30, 104, 196, 242, 154, 170, 79, 138, 58, 202, 119, 87,
            192, 154, 87, 111, 198, 23, 110, 252, 48, 233, 106, 175, 214, 140, 98, 148, 97, 239,
            16, 46, 170, 179, 82, 163, 68, 89, 99, 22, 201, 1, 245, 151, 115, 210, 227, 198, 227,
            126, 216, 114, 226, 209, 66, 238, 134, 123, 222, 109, 182, 212, 129, 81, 157, 113, 177,
            14, 117, 157, 244, 203, 109, 100, 78, 229, 200, 146, 202, 116, 67, 54, 5, 6, 99, 225,
            171, 52, 109, 108, 208, 146, 164, 64, 207, 53, 95, 5, 209, 19, 75, 133, 163, 65, 24, 0,
            207, 158, 145, 145, 131, 4, 181, 220, 224, 148, 81, 101, 189, 107, 98, 205, 188, 125,
            63, 80, 243, 157, 34, 206, 24, 224, 191, 31, 143, 56, 133, 34, 212, 162, 237, 195, 41,
            195, 195, 116, 212, 239, 148, 94, 245, 242, 60, 217, 82, 200, 205, 67, 66, 181, 3, 224,
            247, 26, 13, 188, 43, 49, 40, 202, 161, 54, 199, 209, 28, 247, 238, 200, 25, 46, 196,
            193, 44, 21, 15, 84, 176, 60, 218, 244, 252, 82, 241, 56, 178, 76, 195, 87, 44, 59,
            122, 8, 152, 224, 36, 6, 212, 235, 206, 248, 52, 189, 175, 191, 191, 84, 7, 154, 40,
            28, 124, 141, 202, 141, 60, 177, 121, 143, 4, 54, 158, 243, 81, 3, 190, 78, 123, 127,
            18, 167, 103, 224, 141, 56, 238, 145, 185, 84, 175, 227, 223, 152, 205, 63, 37, 255,
            195, 6, 15, 162, 106, 32, 200, 55, 202, 238, 96, 173, 79, 87, 4, 115, 54, 154, 232,
            216, 56, 129, 32, 74, 34, 18, 222, 235, 81, 183, 190, 111, 13, 203, 92, 50, 166, 94,
            144, 92, 58, 192, 33, 231, 60, 61, 72, 38, 203, 150, 240, 67, 165, 151, 99, 110, 116,
            68, 78, 126, 156, 79, 139, 89, 159, 99, 171, 229, 44, 21, 29, 64, 233, 118, 126, 48,
            150, 241, 179, 144, 146, 1, 121, 228, 154, 157, 171, 223, 62, 51, 70, 48, 100, 137,
            211, 196, 119, 93, 45, 170, 220, 88, 202, 201, 79, 191, 50, 36, 43, 73, 86, 11, 214, 3,
            34, 245, 148, 84, 96, 17, 139, 145, 196, 179, 181, 111, 195, 143, 10, 42, 171, 67, 27,
            202, 235, 132, 2, 105, 109, 14, 215, 140, 41, 57, 13, 7, 101, 30, 213, 243, 134, 41,
            20, 4, 251, 246, 150, 3, 172, 98, 9, 67, 164, 19, 114, 227, 75, 39, 195, 154, 116, 64,
            208, 157, 37, 241, 164, 110, 7, 117, 70, 114, 27, 237, 162, 132, 73, 180, 242, 204,
            117, 151, 28, 204, 54, 234, 40, 164, 234, 123, 204, 130, 252, 14, 42, 8, 205, 191, 229,
            4, 61, 202, 51, 202, 9, 33, 222, 83, 20, 36, 9, 48, 165, 157, 63, 197, 230, 237, 130,
            147, 204, 175, 138, 202, 172, 248, 144, 239, 127, 66, 91, 97, 173, 53, 156, 52, 167,
            244, 41, 211, 171, 246, 5, 241, 7, 42, 238, 39, 121, 196, 203, 157, 204, 102, 97, 27,
            211, 52, 118, 180, 16, 243, 108, 203, 126, 140, 128, 220, 64, 61, 112, 46, 38, 254,
            138, 173, 248, 17, 226, 16, 192, 188, 12, 120, 189, 71, 21, 239, 122, 216, 218, 100,
            126, 240, 8, 110, 148, 153, 7, 214, 201, 252, 127, 100, 237, 18, 156, 203, 22, 12, 80,
            197, 44, 74, 152, 193, 250, 138, 191, 97, 91, 187, 81, 128, 227, 128, 216, 34, 47, 248,
            85, 210, 115, 155, 54, 57, 247, 251, 130, 102, 246, 63, 155, 139, 195, 49, 184, 127, 6,
            107, 174, 49, 164, 31, 250, 243, 60, 91, 18, 152, 65, 190, 124, 179, 33, 59, 13, 162,
            203, 242, 190, 217, 14, 128, 145, 89, 38, 254, 122, 101, 255, 202, 106, 3, 241, 86,
            165, 235, 37, 159, 217, 234, 223, 91, 131, 244, 80, 134, 255, 198, 214, 65, 167, 24,
            198, 92, 205, 12, 48, 208, 63, 162, 39, 35, 200, 215, 215, 12, 190, 49, 210, 165, 182,
            103, 111, 188, 5, 31, 197, 176, 34, 85, 114, 81, 74, 45, 170, 11, 54, 210, 117, 68, 72,
            148, 4, 44, 8, 131, 124, 112, 147, 137, 145, 67, 90, 211, 176, 201, 18, 207, 112, 132,
            90, 187, 5, 221, 12, 254, 3, 102, 34, 67, 111, 217, 196, 9, 184, 84, 196, 237, 173, 9,
            36, 75, 150, 9, 53, 215, 142, 15, 125, 251, 123, 227, 238, 110, 228, 131, 209, 30, 110,
            186, 26, 241, 94, 238, 41, 19, 126, 86, 91, 95, 194, 53, 168, 31, 205, 85, 229, 29,
            163, 142, 81, 80, 173, 10, 185, 137, 188, 157, 101, 226, 196, 144, 133, 46, 89, 160,
            102, 90, 104, 83, 218, 237, 253, 227, 184, 140, 37, 42, 153, 109, 74, 105, 147, 215,
            162, 166, 206, 129, 85, 200, 218, 135, 39, 83, 179, 29, 111, 26, 60, 150, 188, 214, 9,
            214, 128, 249, 23, 37, 68, 7, 193, 118, 71, 142, 219, 92, 75, 115, 115, 119, 230, 101,
            147, 113, 6, 236, 134, 173, 223, 246, 91, 40, 51, 188, 38, 122, 7, 45, 108, 92, 178,
            202, 205, 146, 155, 101, 199, 36, 219, 0, 244, 56, 17, 28, 209, 117, 0, 58, 84, 21,
            218, 201, 97, 46, 1, 58, 7, 12, 188, 205, 209, 205, 177, 22, 157, 82, 15, 128, 85, 223,
            120, 171, 182, 159, 94, 247, 190, 145, 217, 224, 129, 92, 51, 63, 253, 255, 88, 247,
            141, 253, 193, 6, 170, 46, 76, 95, 10, 5, 19, 1, 145, 246, 112, 65, 3, 127, 133, 236,
            166, 147, 85, 163, 164, 9, 75, 214, 43, 255, 66, 154, 97, 173, 189, 139, 121, 246, 180,
            75, 37, 41, 115, 17, 134, 238, 7, 108, 41, 82, 8, 62, 170, 43, 195, 97, 167, 150, 3,
            178, 113, 24, 235, 108, 178, 19, 136, 122, 31, 241, 80, 79, 203, 84, 37, 63, 17, 149,
            161, 146, 245, 254, 149, 101, 109, 126, 78, 51, 219, 150, 102, 140, 225, 146, 173, 254,
            214, 200, 200, 112, 113, 67, 134, 240, 84, 89, 155, 146, 166, 22, 33, 246, 102, 188,
            122, 201, 17, 180, 6, 71, 117, 80, 180, 176, 51, 38, 116, 0, 44, 86, 116, 74, 118, 138,
            140, 61, 106, 66, 9, 97, 216, 42, 100, 163, 161, 102, 174, 101, 15, 236, 19, 252, 58,
            166, 1, 41, 25, 167, 40, 40, 147, 9, 168, 239, 18, 19, 67, 100, 113, 105, 96, 94, 227,
            188, 8, 245, 237, 24, 75, 137, 46, 8, 195, 76, 215, 42, 149, 100, 136, 49, 250, 184,
            11, 136, 116, 91, 108, 237, 51, 48, 124, 101, 185, 40, 25, 207, 111, 10, 26, 64, 62,
            250, 217, 69, 174, 49, 84, 113, 77, 131, 220, 139, 9, 69, 151, 91, 49, 179, 145, 236,
            172, 101, 120, 175, 95, 157, 179, 191, 99, 127, 246, 229, 180, 246, 212, 77, 252, 211,
            14, 12, 163, 172, 140, 165, 106, 63, 82, 142, 19, 42, 74, 113, 17, 161, 103, 80, 93,
            190, 122, 114, 21, 204, 192, 201, 164, 87, 84, 2, 250, 18, 248, 165, 229, 51, 50, 253,
            121, 178, 26, 218, 73, 213, 70, 206, 116, 99, 82, 66, 105, 20, 143, 138, 159, 234, 195,
            232, 26, 124, 22, 145, 31, 93, 201, 162, 9, 201, 42, 159, 97, 25, 45, 252, 76, 65, 11,
            51, 139, 246, 206, 53, 71, 115, 162, 64, 203, 142, 108, 223, 209, 136, 215, 100, 12,
            101, 34, 139, 145, 67, 169, 67, 22, 148, 141, 43, 102, 118, 226, 27, 68, 50, 161, 243,
            36, 239, 253, 106, 80, 87, 245, 76, 95, 133, 41, 165, 32, 19, 152, 42, 155, 196, 180,
            68, 230, 169, 133, 135, 125, 133, 62, 166, 142, 190, 60, 170, 1, 105, 224, 191, 230,
            29, 239, 14, 213, 62, 245, 220, 11, 239, 90, 253, 240, 129, 44, 248, 169, 254, 169,
            240, 134, 227, 190, 69, 166, 250, 202, 176, 98, 63, 125, 171, 230, 65, 172, 26, 9, 91,
            234, 78, 208, 109, 163, 84, 89, 155, 248, 205, 205, 0, 210, 161, 52, 91, 201, 196, 229,
            50, 8, 169, 104, 95, 233, 103, 122, 40, 206, 56, 79, 253, 250, 152, 197, 158, 52, 213,
            67, 177, 244, 118, 175, 161, 98, 246, 60, 138, 41, 109, 140, 23, 241, 191, 219, 183,
            171, 171, 205, 244, 175, 78, 242, 81, 188, 164, 216, 87, 42, 205, 79, 82, 103, 61, 109,
            128, 89, 92, 99, 241, 126, 29, 184, 221, 248, 201, 148, 33, 116, 211, 237, 180, 181,
            243, 219, 161, 10, 78, 67, 43, 24, 232, 134, 38, 11, 235, 173, 118, 111, 97, 167, 33,
            7, 146, 253, 11, 245, 112, 218, 175, 140, 219, 108, 172, 233, 12, 233, 238, 74, 234,
            208, 10, 195, 7, 107, 23, 165, 180, 154, 228, 108, 125, 136, 197, 25, 247, 202, 191,
            187, 213, 84, 55, 118, 61, 29, 132, 183, 63, 142, 7, 128, 48, 116, 11, 189, 67, 39, 97,
            198, 49, 186, 116, 106, 221, 109, 253, 164, 115, 138, 183, 115, 112, 200, 182, 103, 95,
            33, 248, 41, 116, 145, 246, 187, 19, 18, 253, 9, 208, 172, 58, 116, 101, 208, 202, 28,
            3, 235, 187, 102, 15, 10, 188, 216, 189, 35, 16, 120, 241, 213, 159, 4, 206, 32, 47,
            230, 243, 24, 6, 114, 46, 156, 235, 103, 239, 253, 2, 20, 93, 85, 64, 113, 44, 159, 62,
            186, 189, 242, 151, 39, 148, 38, 90, 246, 186, 32, 132, 201, 63, 86, 207, 155, 181,
            123, 221, 16, 68, 250, 215, 192, 65, 157, 193, 143, 3, 29, 208, 63, 197, 240, 1, 58,
            200, 251, 128, 74, 115, 71, 75, 1, 150, 82, 233, 162, 166, 64, 31, 142, 125, 194, 6,
            103, 72, 243, 103, 75, 80, 17, 133, 17, 105, 116, 58, 22, 121, 55, 50, 62, 142, 101,
            156, 249, 107, 9, 204, 186, 162, 136, 248, 170, 98, 208, 24, 75, 243, 24, 206, 153, 84,
            223, 206, 228, 235, 146, 90, 151, 245, 205, 138, 202, 157, 90, 185, 44, 184, 238, 218,
            247, 241, 102, 116, 99, 53, 202, 125, 92, 43, 96, 104, 148, 45, 45, 10, 73, 245, 116,
            211, 156, 82, 140, 16, 32, 102, 209, 156, 249, 244, 105, 135, 188, 219, 98, 50, 109,
            211, 44, 180, 128, 205, 56, 204, 222, 87, 127, 221, 27, 205, 37, 170, 89, 172, 89, 187,
            174, 16, 74, 165, 196, 219, 98, 133, 133, 13, 209, 163, 5, 157, 54, 155, 102, 167, 246,
            187, 243, 105, 56, 112, 241, 2, 227, 211, 206, 239, 130, 119, 42, 127, 243, 127, 12,
            178, 253, 178, 128, 168, 153, 196, 79, 196, 162, 216, 132, 50, 3, 253, 168, 221, 171,
            144, 58, 67, 161, 238, 137, 32, 193, 243, 192, 57, 124, 188, 48, 1, 238, 2, 166, 214,
            118, 238, 237, 205, 200, 92, 121, 237, 57, 24, 155, 244, 87, 56, 249, 80, 8, 205, 187,
            94, 232, 39, 244, 205, 7, 139, 68, 88, 245, 51, 169, 128, 69, 234, 7, 149, 203, 185, 4,
            4, 187, 39, 37, 4, 58, 98, 2, 46, 153, 50, 124, 0, 1, 239, 14, 120, 84, 8, 86, 222,
            244, 223, 100, 129, 176, 29, 84, 108, 91, 215, 145, 7, 196, 49, 63, 230, 29, 243, 50,
            75, 126, 90, 125, 212, 183, 254, 217, 132, 74, 167, 159, 152, 52, 93, 186, 160, 95,
            174, 4, 32, 164, 69, 172, 241, 119, 253, 221, 145, 35, 223, 206, 81, 47, 79, 205, 99,
            206, 16, 44, 31, 122, 101, 71, 128, 252, 79, 183, 110, 93, 110, 151, 149, 68, 170, 126,
            253, 116, 118, 219, 108, 56, 139, 93, 252, 16, 21, 231, 182, 39, 64, 125, 252, 244, 49,
            62, 36, 240, 62, 68, 211, 210, 13, 191, 13, 240, 219, 91, 87, 169, 6, 33, 67, 233, 226,
            41, 103, 99, 156, 204, 160, 179, 97, 149, 16, 170, 181, 41, 175, 23, 133, 241, 86, 122,
            117, 5, 165, 247, 46, 90, 131, 168, 64, 102, 134, 235, 126, 47, 49, 178, 151, 74, 127,
            121, 181, 24, 10, 120, 38, 194, 3, 250, 191, 130, 239, 21, 19, 201, 94, 2, 217, 176,
            153, 107, 122, 199, 163, 31, 217, 239, 36, 76, 14, 8, 190, 153, 110, 88, 235, 221, 231,
            47, 214, 91, 105, 140, 172, 99, 185, 231, 164, 181, 67, 13, 135, 118, 44, 95, 246, 47,
            25, 147, 49, 81, 72, 147, 82, 147, 136, 18, 136, 130, 68, 138, 83, 119, 60, 168, 151,
            60, 171, 137, 103, 14, 162, 150, 113, 222, 251, 88, 231, 14, 243, 48, 41, 113, 251, 47,
            77, 183, 148, 150, 77, 222, 18, 34, 66, 159, 6, 103, 201, 38, 225, 132, 214, 114, 94,
            127, 163, 170, 1, 185, 95, 195, 220, 243, 224, 235, 121, 237, 230, 155, 37, 36, 211,
            88, 75, 244, 7, 191, 216, 155, 128, 82, 255, 245, 51, 106, 183, 23, 121, 61, 16, 208,
            18, 255, 232, 131, 112, 219, 241, 172, 178, 235, 74, 5, 16, 242, 17, 181, 136, 197,
            236, 20, 226, 74, 21, 24, 108, 46, 141, 177, 157, 110, 82, 50, 183, 173, 168, 163, 179,
            159, 7, 212, 175, 242, 68, 82, 248, 127, 227, 216, 187, 83, 218, 136, 1, 162, 151, 55,
            64, 234, 124, 224, 45, 150, 189, 135, 26, 58, 14, 175, 91, 152, 227, 3, 78, 207, 213,
            160, 223, 125, 108, 250, 60, 57, 158, 40, 149, 206, 124, 240, 33, 45, 4, 255, 46, 77,
            68, 63, 103, 222, 77, 55, 72, 51, 134, 74, 143, 146, 29, 185, 124, 229, 25, 93, 91,
            217, 238, 253, 221, 60, 228, 145, 77, 35, 126, 215, 91, 83, 58, 207, 85, 174, 254, 100,
            12, 53, 80, 252, 191, 201, 148, 169, 129, 66, 250, 133, 7, 74, 136, 235, 75, 75, 5, 93,
            192, 245, 63, 208, 150, 24, 31, 201, 140, 217, 75, 182, 113, 139, 34, 95, 63, 34, 180,
            32, 54, 203, 163, 6, 4, 138, 117, 178, 171, 204, 42, 94, 140, 167, 232, 189, 204, 17,
            182, 164, 82, 112, 45, 208, 29, 148, 124, 83, 233, 165, 204, 5, 76, 61, 143, 60, 74, 8,
            249, 55, 61, 182, 62, 49, 190, 172, 5, 194, 165, 1, 6, 171, 7, 228, 104, 172, 109, 238,
            162, 22, 248, 162, 162, 67, 110, 183, 85, 131, 84, 234, 88, 106, 71, 225, 197, 180, 19,
            48, 52, 25, 141, 244, 6, 135, 127, 193, 8, 243, 120, 44, 104, 255, 152, 182, 235, 90,
            154, 71, 185, 49, 190, 193, 49, 157, 4, 19, 55, 166, 207, 183, 162, 54, 127, 93, 115,
            219, 132, 118, 55, 164, 20, 50, 243, 41, 149, 104, 43, 131, 52, 154, 27, 57, 39, 129,
            122, 157, 189, 51, 23, 81, 193, 248, 134, 133, 192, 193, 251, 46, 34, 253, 68, 113,
            144, 75, 89, 29, 222, 134, 240, 129, 140, 241, 120, 254, 203, 211, 200, 64, 84, 234,
            254, 23, 231, 241, 32, 160, 238, 239, 255, 68, 92, 93, 52, 230, 101, 111, 191, 62, 246,
            207, 69, 133, 203, 213, 162, 170, 234, 76, 71, 141, 186, 162, 209, 151, 38, 206, 128,
            36, 86, 224, 45, 142, 32, 227, 133, 168, 220, 94, 77, 156, 161, 144, 124, 37, 77, 223,
            175, 50, 194, 37, 252, 67, 16, 105, 68, 228, 60, 172, 19, 109, 142, 96, 141, 76, 95,
            217, 238, 213, 235, 29, 112, 34, 2, 56, 101, 3, 88, 184, 57, 179, 57, 97, 184, 42, 144,
            157, 125, 85, 24, 113, 11, 124, 165, 100, 67, 173, 159, 132, 129, 121, 198, 202, 228,
            99, 244, 105, 150, 167, 7, 118, 75, 222, 97, 163, 244, 251, 56, 3, 221, 104, 101, 223,
            56, 179, 99, 128, 159, 137, 108, 94, 228, 34, 116, 144, 230, 173, 177, 255, 247, 54,
            61, 38, 56, 233, 32, 120, 144, 84, 222, 14, 176, 165, 222, 40, 86, 141, 122, 211, 251,
            215, 197, 19, 45, 113, 236, 61, 192, 62, 145, 198, 35, 244, 138, 17, 166, 109, 189,
            118, 72, 10, 52, 205, 57, 1, 87, 2, 237, 17, 74, 128, 37, 31, 213, 139, 68, 125, 91,
            59, 236, 122, 130, 231, 0, 69, 243, 131, 171, 34, 114, 52, 104, 48, 78, 116, 76, 136,
            167, 254, 181, 9, 89, 73, 106, 183, 173, 137, 189, 211, 10, 56, 80, 196, 6, 86, 66, 36,
            199, 32, 109, 4, 238, 114, 181, 196, 155, 240, 35, 255, 216, 51, 95, 29, 207, 130, 75,
            6, 233, 205, 118, 8, 214, 74, 210, 168, 4, 3, 247, 174, 126, 47, 94, 217, 11, 87, 115,
            150, 238, 55, 105, 172, 15, 161, 237, 4, 20, 9, 32, 232, 107, 188, 159, 78, 202, 109,
            182, 21, 242, 243, 102, 87, 43, 61, 207, 132, 221, 245, 200, 243, 222, 45, 157, 161,
            181, 23, 212, 214, 43, 93, 209, 85, 250, 74, 97, 144, 241, 14, 218, 119, 233, 12, 15,
            121, 82, 204, 11, 128, 119, 210, 163, 223, 239, 149, 0, 238, 37, 208, 0, 189, 154, 51,
            129, 223, 49, 216, 155, 100, 237, 84, 79, 212, 134, 234, 222, 103, 248, 47, 245, 121,
            18, 187, 61, 59, 113, 65, 65, 34, 94, 186, 53, 20, 249, 221,
        ];
        let res = super::decrypt(&key, &mut crypted[..]);
        let bytes = res.unwrap();
        println!("{:x?}", bytes);
        println!("{}", std::str::from_utf8(bytes).unwrap());
    }
    #[test]
    fn decrypt2() {
        let subscriber = tracing_subscriber::FmtSubscriber::builder()
            .with_env_filter(
                "trace,hyper=info"
                    .parse::<tracing_subscriber::EnvFilter>()
                    .unwrap(),
            )
            .with_writer(std::io::stderr)
            .finish();
        tracing::subscriber::set_global_default(subscriber)
            .expect("setting default subscriber failed");
        let jk = "function f(){ return '38353937383130333133313035353834';}";
        let crypted = "CtxRkaMixz2uVnaVYYBrfScrcg64tBZsJVydF1w5QbOymqBUnwG/7p7vBWwTvc4ZgyRqWUpPhtOe+WLWI1qVpjUH1WSdIpDOsH0F1KmCCu2hD7YA2p6IsGzUMpUxDbVoneNe+txErfoNoN/MpRFNkEcpGrlD9kdBEV6LTEHCK6icg6xaF6ezqGZCeUeYjNqzTJkItR0LP0er3slHYGToMZ+SGwKymYjGZ9sYJAtwZT/pJvqeZ88DszFa/ZMFUcWVLc+haF1LPBWnU79uP5wCIrMT/5AsDtf9SxsEoqBmyT3m5OOmBVhFfFwJGyN2fvBZWU7uY4vcb49ZKzXIq5PwZxE9MzT1wKOAWXssZweyrvr/WqLu/xn4adimn+GqY5xCi1OyWViUypPHxm7xjBvmvubeU9pRpmfBRUWK40C4j7WhAy6oKz9G1tFKuvgsEqb1vk0b/uqLrAy39cjfdDZfXkl4kT3hfetxTVe5rU0ewZHOYaHFEjHs35TAICD3IrL6jSIZZI2Mw1RdvEUWkZ0EBRtHHYOSMUO8jvxy8SqYQMDuvaxd45Dzr3rk+7P++QPQx7RLV9W2WsxlGtdFjTXv7MBhAMf9MsfrRu91wX+YMRKMJAi1rwtcde+fW+x8qjSxw3MrnpFlFqxyw5USMlj7f5h5qNQHXZ/UfxvmsFopRuH6zqx4UryakJbxTHnxUdbS9zODMQfPP9bBvxBxxtOIcQuOWwaAl70reLmXvEVnEVDNWTDEMc8V19RfmwS5GewvlvUFq3GhvOV5r0vmBjCUja1dBS21vN+JNYa0kOCvcRLkxRba7SGw4f5Bd7hQy/6qsvz4rk2QM4TaB0xyAz0Zn8gUuGQKv7eVMMTteYPq4x9YRd0tEJIERLlYZES3AZI7MhUWOw/f34e+OakuXyHNqA==";
        let key = super::key_from_snippet(jk).unwrap();
        let mut payload =
            base64::Engine::decode(&base64::engine::general_purpose::STANDARD, &crypted).unwrap();
        let res = super::decrypt(&hex::decode(key).unwrap(), &mut payload[..]);
        let bytes = res.unwrap();
        println!("{:x?}", bytes);
        println!("{}", std::str::from_utf8(bytes).unwrap());
    }
}
